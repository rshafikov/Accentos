## Список проверок настроек ВебГарда

## Глобальные настройки:

1. Виртуальные машины с ВебГардами должны быть в группе анти-афиннити

2. Виртуальные машины с ВебГардами должны находиться в разных кластерах: ВГ1 и ВГ3 должны быть в зоне nova, ВГ2 в зоне tz

3. На всех ВГ должна быть отключена безопасность портов и группы безопасности

4. TRS-проекты для подключения к виртуальным машинам должны быть настроены корректно

5. Создаваемые ВМ внутри TRS-проектов должны быть в домене

6. Настройки авторизации прописаны для пользователей обоих доменов, сделать это можно по адресу http://<wg_ip>:8081(8080)/security-manager/login (порт определяет домен)

7. Пользователи обоих доменов могут успешно аутентифицироваться в веб-версии ВГ http://<wg_ip>/ 

## Настройки виртуальных машин с ВГ:

1. Все ВГ должны быть в кластере etcd:
    ```sh
    ETCDCTL_API=3 etcdctl endpoint status --cluster -w table
    # примерный вывод
    +---------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+
    |         ENDPOINT          |        ID        | VERSION | DB SIZE | IS LEADER | IS LEARNER | RAFT TERM | RAFT INDEX | RAFT APPLIED INDEX | ERRORS |
    +---------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+
    | http://10.246.160.13:2379 | c4a6f979efda1055 |   3.4.9 |   20 kB |      true |      false |      7927 |   20556550 |           20556550 |        |
    |  http://10.246.160.9:2379 | dc68774a4558a350 |   3.4.9 |   20 kB |     false |      false |      7927 |   20556550 |           20556550 |        |
    | http://10.246.160.11:2379 | e8468db8859b226f |   3.4.9 |   20 kB |     false |      false |      7927 |   20556550 |           20556550 |        |
    +---------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+
    ```

2. Patroni также должен корректно отображать кластер:
    ```sh
    patronictl -c /etc/patroni1.yml list
    # примерный вывод
    +-------------+----------+---------+---------+----+-----------+
    | Member      | Host     | Role    | State   | TL | Lag in MB |
    + Cluster: wg (7111322903063996647) ---------+----+-----------+
    | postgresql1 | wg1:5442 | Leader  | running | 27 |           |
    | postgresql2 | wg2:5442 | Replica | running | 25 |     10099 |
    | postgresql3 | wg3:5442 | Replica | running | 27 |         0 |
    +-------------+----------+---------+---------+----+-----------+
    ```

3. Связность между ВГ присутствует, доступ до доменов настроен:
    ```sh
    # запустить проверочный скрипт
    /root/conn_checker.sh
    # все тесты должны быть "ok"
    ```

## Получение виртуальных машин с АРМов:

1. Получение ВМ из домена FreeIPA происходит успешно

1. Получение ВМ из домена MS AD происходит успешно

